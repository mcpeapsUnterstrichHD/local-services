- type: custom-api
  title: Nginx Proxy Manager
  url: ${NGINX_PROXY_URL}/api/tokens
  method: POST
  body-type: json
  body:
    identity: ${NGINX_EMAIL_ID}
    secret: ${NGINX_PASSWORD}
  cache: 12h
  options:
    collapse-after: -1
    show-icons: true
    domain-name: ".localhost"
    tooltip-enabled: true
    # custom icons (example keys)
    code: coder
    paperless: paperlessngx
    docker: docker
    glance: https://cdn.jsdelivr.net/gh/selfhst/icons/svg/glance-dark.svg
    portainer: portainer
  template: |
    <style>
      .widget-type-nginx li {
        margin-top: var(--list-half-gap);
        border-top: 1px solid var(--color-separator);
        padding-top: var(--list-half-gap);
      }
      .widget-ngix-proxy-icon, .widget-ngix-proxy-icon-default  {
        display: block;
        filter: grayscale(0.4);
        object-fit: contain;
        aspect-ratio: 1 / 1;
        width: 2.7rem;
        opacity: 0.8;
        transition: filter 0.3s, opacity 0.3s;
      }
      // DISABLE THE BELOW CSS FOR COLOR ICONS
      :root[data-scheme="dark"] .widget-ngix-proxy-icon {
        filter: invert(100%); // this to invert colors for dark and light theme
      }
    </style>
    {{ $defaultIconUrl := "https://cdn.jsdelivr.net/gh/selfhst/icons/svg/nginx-proxy-manager.svg" }}
    {{ if eq .Response.StatusCode 200 }}
      {{ $accessToken := .JSON.String "token" }}
      {{
        $proxyHosts := newRequest (concat "${NGINX_PROXY_URL}" "/api/nginx/proxy-hosts")
          | withHeader "Authorization" (print "Bearer " $accessToken)
          | getResponse
      }}
      <ul  class="dynamic-columns list list-gap-15 list-with-separator  collapsible-container"  data-collapse-after="{{ .Options.IntOr "collapse-after" 6 }}">
        {{ range $proxyHosts.JSON.Array "" }}
          {{ if and (.String "domain_names.0") (.Bool "enabled")  }}
            {{ $proxy_url  := (concat (.String "forward_scheme") "://" (.String "domain_names.0") ) }}
            {{ $host_url   := (concat (.String "forward_scheme") "://" (.String "forward_host") ":" (.String "forward_port") ) }}
            {{ $subDomain  := .String "domain_names.0" | trimSuffix ($.Options.StringOr "domain-name" "") }}
            <li class="flex items-center gap-20" >
              <!-- Icon Section -->
              {{ if $.Options.BoolOr "show-icons" true }}
                <div class="shrink-0">
                    {{ $iconUrl := $.Options.StringOr $subDomain $defaultIconUrl}}
                    {{ if eq $iconUrl $defaultIconUrl }}
                      <img class="widget-ngix-proxy-icon-default" src="{{ $defaultIconUrl }}" loading="lazy">
                    {{ else }}
                      {{ if ne (findMatch "://" $iconUrl)  "://" }} <!-- check if url is NOT provided -->
                        <img class="widget-ngix-proxy-icon" src="https://simpleicons.org/icons/{{$iconUrl}}.svg" loading="lazy">
                      {{ else }}
                        <img class="widget-ngix-proxy-icon" src="{{ $iconUrl }}" loading="lazy">
                      {{ end }}
                    {{ end }}
                </div>
              {{ end }}
              <!-- Proxy URLs Section -->
              <div class="min-width-0 grow">
                <a href='{{ $proxy_url }}' class="color-highlight size-title-dynamic block" style="display: inline;" target="_blank" rel="noreferrer"
                    {{if $.Options.BoolOr "tooltip-enabled" false}}data-popover-type="text" data-popover-text="{{$proxy_url}}"{{end}}
                  >{{ $subDomain }}</a>
                <div class="flex items-center gap-10" style="margin-bottom: 5px">
                  <div class="text-left">
                        âž”
                  </div>
                  <div class="size-h6 flex-1 text-left">
                    <a href='{{ $host_url }}' target="_blank" rel="noreferrer">{{ $host_url }}</a>
                  </div>
                </div>
              </div>
            </li>
          {{ end }}
        {{ end }}
      </ul>
    {{ else }}
      <p class='color-negative'>Failed to get token: {{ .JSON.String "error.message" }} ({{ $.Response.Status }}) </p>
    {{ end }}
